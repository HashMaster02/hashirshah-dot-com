---
import Layout from "../../layouts/default.astro";
import { getCollection } from "astro:content";
import "../../stylesheets/blog-md.css"; // using imported stylesheet for <Content> element compatibility
import TrackList from "../../components/TrackList.astro";
import { parseTime, formatTime } from "../../utils/format-timestamps";

export async function getStaticPaths() {
  const allPosts = await getCollection("blog");

  return allPosts.map((post) => {
    const slugParts = post.slug.split("/");
    const pageSlug = slugParts[slugParts.length - 1];
    return {
      params: {
        albumslug: post.data.albumslug,
        slug: pageSlug,
      },
      props: { post, allPosts },
    };
  });
}

const { post, allPosts } = Astro.props;
const [_, currentAlbum, currentBlog] = Astro.url.pathname.split("/");
const filteredPosts = allPosts.filter((post) => {
  return post.slug.startsWith(currentAlbum) && !post.slug.endsWith(currentBlog);
});
const { Content } = await post.render();
---

<Layout>
  <div class="container">
    <a class="home-button" href=`/${Astro.params.albumslug}`>
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
        <path
          fill="currentColor"
          d="M19 7v4H5.83l3.58-3.59L8 6l-6 6l6 6l1.41-1.42L5.83 13H21V7z"
        ></path></svg
      >
    </a>
    <div class="blog">
      <h1 class="title">{post.data.title}</h1>
      <small>
        <p>{formatTime(parseTime(post.data.runtime))}</p>
      </small>
      <div class="divider"></div>
      <Content />
    </div>
    <div class="up-next collapse">
      <svg
        id="up-next-menu-button"
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
      >
        <path
          fill="currentColor"
          d="M10.589 12.5H15q.213 0 .356-.144t.144-.357t-.144-.356T15 11.5h-4.411l1.765-1.766q.14-.133.14-.34t-.14-.348t-.347-.14q-.208 0-.341.14l-2.389 2.389q-.242.242-.242.565t.242.566l2.389 2.388q.14.14.344.13q.204-.009.344-.15t.14-.347t-.14-.34zm1.414 8.5q-1.866 0-3.51-.708q-1.643-.709-2.859-1.924t-1.925-2.856T3 12.003t.709-3.51Q4.417 6.85 5.63 5.634t2.857-1.925T11.997 3t3.51.709q1.643.708 2.859 1.922t1.925 2.857t.709 3.509t-.708 3.51t-1.924 2.859t-2.856 1.925t-3.509.709"
        ></path></svg
      >
      <p>Other Tracks</p>
      <TrackList blogs={filteredPosts} />
    </div>
  </div>
  <script>
    import "../../scripts/upnext-menu";
  </script>
</Layout>

<style>
  .home-button {
    width: 42px;
    color: var(--secondary);
    a {
      color: inherit;
    }

    &:hover {
      color: var(--accent);
    }
  }

  .container {
    position: relative;
    display: flex;
    justify-content: center;
    flex-direction: column;
    font-size: var(--body-mobile);
  }

  .blog {
    max-width: 70ch;
    font-family: "Domine";
    color: var(--text);
    line-height: 1.5;
    letter-spacing: 0.25px;
  }

  .up-next {
    display: grid;
    grid-template-columns: auto 1fr;
    grid-template-rows: auto 1fr;
    position: fixed;
    bottom: 0;
    left: 0%;
    width: 100%;
    background-color: var(--background);
    box-sizing: border-box;
    padding: var(--global-side-padding-mobile);
    box-shadow: 0 4px 12px rgba(255, 255, 255, 1);

    div {
      margin-top: 1.5rem;
      grid-column: 1 / 3;
    }

    & > p {
      position: sticky;
      color: var(--secondary);
      font-size: var(--title-mobile);
      font-family: "Manrope";
      font-weight: 800;
      align-self: center;
    }

    & svg {
      width: 42px;
      position: sticky;
      color: var(--secondary);
      margin-right: 1rem;
      transform: rotate(-90deg);
      cursor: pointer;
      align-self: center;

      &:hover {
        color: var(--accent);
      }
    }
  }

  .up-next.collapse {
    & svg {
      transform: rotate(90deg);
    }
    .tracklist {
      display: none;
    }
  }

  .title {
    font-size: 2rem;
    font-style: italic;
  }

  .divider {
    width: 100%;
    border: 1px solid var(--accent);
    margin-bottom: 2rem;
  }

  @media screen and (min-width: 810px) {
    .home-button {
      width: 62px;
    }
    .container {
      flex-direction: row;
      color: var(--text);
      font-size: var(--body-desktop);
      grid-template-columns: 3fr 2fr;
    }

    .blog {
      padding-bottom: 1rem;
      margin: 0 auto;
    }

    .up-next {
      position: relative;
      box-shadow: none;
      border-left: 2px solid var(--accent);
      width: 30%;

      div {
        grid-column: 2 / 3;
      }

      & svg {
        width: 62px;
        transform: rotate(180deg);
      }
    }

    .up-next.collapse {
      grid-template-columns: 1fr;
      min-width: 0;
      width: fit-content;

      & p {
        display: none;
      }
      & svg {
        transform: rotate(0deg);
      }
    }
  }
</style>
